# AGENTS.md

## 发布流程（本项目）

硬性要求：**每次 build 没问题，必须直接推送到 main，并立即部署到 Cloudflare。**

每次功能改动后，按下面顺序执行：

1. **Build 校验**
   - 命令：`npm run build`
   - 要求：构建成功（允许 Next.js 的 TypeScript 推荐版本 warning）

2. **推送到 main**
   - 命令：
     - `git add .`
     - `git commit -m "<你的提交说明>"`
     - `git push origin main`

3. **部署到 Cloudflare Pages**
   - 命令：
     - `npx wrangler pages deploy out --project-name bj-car-points --branch main`

## 说明

- 本项目使用 Next.js 静态导出（`output: "export"`），部署目录是 `out/`。
- 若 Cloudflare API 临时报错（如 503），可直接重试部署命令。
- 线上固定地址：`https://bj-car-points.pages.dev`

---

## 北京小客车家庭积分政策补充（实现口径）

参考：<https://xkczb.jtw.beijing.gov.cn/bszn/20201230/1609342087846_1.html>

> 最终以当年官方公告与调控系统为准。以下用于产品实现与交互约束。

### 一、个人积分

个人积分 `P_i`：

- `P_i = B_i + O_i + N_i + Y`
- `B_i`：基础分（主申请人 2，其他成员 1）
- `O_i`：普通指标阶梯分（由参与期数折算）
- `N_i`：新能源轮候分（按年折算）
- `Y`：家庭申请年限分（每满一年全员 +1）

### 二、家庭总积分（核心）

- **含配偶**：
  - `S = ((P_main + P_spouse) × 2 + ΣP_others) × G`
- **不含配偶**：
  - `S = (P_main + ΣP_others) × G`

其中 `G` 为家庭代际数（通常 1~3）。

### 三、普通摇号期数与阶梯映射（工程）

- 用户不填分，只填“开始年份 + 上/下半年”。
- 先估算参与期数 `R`，再映射阶梯分 `O`。
- 示例映射（可配置）：
  - `O=0` 当 `R=0`
  - `O=1 + floor((R-1)/24)` 当 `R>0`
- 规则必须配置化，不写死。

### 四、交互约束（傻瓜式）

- 禁止让用户手填“最终积分/阶梯结果”。
- 仅输入：普通开始年（含上/下半年）、新能源轮候开始年、家庭申请开始年、成员结构。
- 系统自动展示：期数估算、阶梯映射、个人积分拆解、家庭总分公式展开。

### 五、政策边界提示（页面必须有）

- 新能源同分：按家庭申请人中最早注册时间排序。
- 同一家庭可同时申请普通+新能源，但最终只能取得一个指标。
- 以家庭取得新能源指标后，家庭申请人按政策问答口径通常存在一定年限（常见口径 10 年）不能再申请。
- 普通指标常见截止口径：3月8日 / 10月8日（以当年公告为准）。
