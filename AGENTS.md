# AGENTS.md

## 发布流程（本项目）

硬性要求：**每次 build 没问题，必须直接推送到 main，并立即部署到 Cloudflare。**

每次功能改动后，按下面顺序执行：

1. **Build 校验**
   - 命令：`npm run build`
   - 要求：构建成功（允许 Next.js 的 TypeScript 推荐版本 warning）

2. **推送到 main**
   - 命令：
     - `git add .`
     - `git commit -m "<你的提交说明>"`
     - `git push origin main`

3. **部署到 Cloudflare Pages**
   - 命令：
     - `npx wrangler pages deploy out --project-name bj-car-points --branch main`

## 说明

- 本项目使用 Next.js 静态导出（`output: "export"`），部署目录是 `out/`。
- 若 Cloudflare API 临时报错（如 503），可直接重试部署命令。
- 线上固定地址：`https://bj-car-points.pages.dev`

---

## 北京小客车家庭积分政策补充（实现口径）

参考：<https://xkczb.jtw.beijing.gov.cn/bszn/20201230/1609342087846_1.html>

> 最终以当年官方公告与调控系统为准。以下为产品实现规则，重点是“三、家庭总积分计算说明”。

### 三、家庭总积分计算说明（详细版）

家庭申请人积分由**基础积分**和**阶梯（轮候）积分**组成。

#### （一）基础积分说明

- 家庭主申请人的基础积分为 **2分**。
- 其他家庭申请人的基础积分为 **每人1分**。

#### （二）阶梯（轮候）积分说明

1) 家庭申请人当前在参加普通小客车指标摇号的：

- 阶梯积分 = 按其累积的阶梯数，每1阶梯加1分。
- 具有有效残疾人专用小型自动挡载客汽车准驾车型驾驶证（C5）的**家庭主申请人**，额外增加1个阶梯数；其他家庭申请人不额外增加阶梯数。

阶梯积分规则（原文口径整理）：

- 截至2020-12-31（累计共78次摇号）对应口径：
  - 0次 → 0分
  - 1-2次 → 1分
  - 3-4次 → 2分
  - 5-6次 → 3分
  - 7-8次 → 4分
  - ……
- 2021-01-01以后累计参加个人摇号次数对应口径（常见分段示例）：
  - 0次 → 0分
  - 1-6次 → 1分
  - 7-12次 → 2分
  - 13-18次 → 3分
  - 19-24次 → 4分
  - 25-30次 → 5分
  - 31-36次 → 6分
  - 37-42次 → 7分
  - 43-48次 → 8分
  - 49-54次 → 9分
  - 55-60次 → 10分
  - 61-66次 → 11分
  - 67-72次 → 12分
  - 73-78次 → 13分

> 实现建议：阶梯映射表必须配置化，不要写死在页面。

2) 家庭申请人正在轮候新能源小客车指标的：

- 按其最近一次开始轮候时间，距离家庭摇号申请年上一年12月31日，**每满一年加1分**。
- 其以往参加摇号获得的阶梯数与轮候年限分合并求和，得到阶梯（轮候）积分。

注：家庭申请人正在轮候新能源小客车指标的，参与家庭申报后，其以个人身份申请新能源小客车指标的轮候时间不再保留（原轮候次序不保留）。

3) 以往没有参加摇号或轮候的：

- 阶梯（轮候）积分为 **0**。

4) 家庭申请年限加分：

- 以家庭为单位申请，每满一年，所有家庭申请人积分各增加 **1分**。

#### （三）家庭申请人积分说明

- 家庭申请人积分 = 家庭申请人基础积分 + 家庭申请人阶梯（轮候）积分。

#### （四）家庭总积分说明

1) 家庭申请人中包含家庭主申请人配偶：

- 总积分 = `[(主申请人积分 + 配偶积分) × 2 + 其他成员积分之和] × 家庭代际数`

2) 家庭申请人中不包含家庭主申请人配偶：

- 总积分 = `(主申请人积分 + 其他成员积分之和) × 家庭代际数`

家庭代际数是指家庭申请人中包含有几代人，最多为 **3代**。

### 四、家庭总积分使用说明（详细版）

#### （一）家庭申请普通指标的阶梯中签率说明

- 家庭与个人同池摇号。
- 家庭总积分分数，即该家庭申请编码出现在摇号池中的次数。
- 编码出现次数越多，中签率越高，但同一编码只能中签一次。

#### （二）家庭申请新能源指标的积分排序说明

- 家庭申请新能源指标时，按家庭总积分由高到低排序配置。
- 总积分相同的家庭，按家庭申请人中最早在小客车指标调控管理信息系统注册时间先后排序配置。

#### （三）当期基准中签率

- 第一阶梯申请人的中签率是当期基准中签率。
- 若某申请人中签率为基准中签率的2倍（或多倍），其申请编码对应2个（或多个）摇号基数序号。
- 当其中一个基数序号中签，该申请编码即中签（且最多中签一次）。

公式：

- 当期基准中签率 = `当期指标配额 / (第一阶梯人数×1 + 第二阶梯人数×2 + 第三阶梯人数×3 + …)`

#### （四）摇号基数序号

- 摇号基数序号在指标配置月25日生成并公证，参与6月26日、12月26日摇号。
- 具体分配规则：
  1. 先将当期所有审核通过编码按从小到大分配一次序号；
  2. 第二阶梯及以上编码，再按从小到大追加分配一次序号；
  3. 第三阶梯及以上编码，再追加分配一次；
  4. 以此类推。

总数公式：

- 当期摇号基数序号总数 = `第一阶梯人数×1 + 第二阶梯人数×2 + 第三阶梯人数×3 + …`

#### （五）阶梯中签率的实现

- 摇号程序从当期所有摇号基数序号中随机抽取中签者。
- 高阶梯编码因为拥有多个基数序号，中签率对应为基准中签率的多倍。
- 但系统保证同一申请编码最多只中签一次。

---

## 产品实现约束（必须遵守）

- 不允许用户手填“最终分值”或“阶梯分结果”。
- 必须通过时间与成员结构自动计算。
- 普通指标需支持“上半年/下半年”输入与期数估算。
- 页面必须展示“以当年公告和系统结果为准”的明确提示。
- 同分排序、成员变化重申规则、取得新能源后限制规则必须展示。
